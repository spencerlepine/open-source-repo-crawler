name: ðŸ“ Status Reporter

# Notes:
# trigger lambda function, get metadata on RedisCache
# get size of contribution repository

on:
  workflow_dispatch:
  # Run job every sunday at 12:00pm
  # schedule:
  #             # https://crontab.guru/
  #             #   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)
  #             # â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)
  #             # â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the month (1 - 31)
  #             # â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12 or JAN-DEC)
  #             # â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the week (0 - 6 or SUN-SAT)
  #             # â”‚ â”‚ â”‚ â”‚ â”‚
  #             # â”‚ â”‚ â”‚ â”‚ â”‚
  #             # â”‚ â”‚ â”‚ â”‚ â”‚
  #             # * * * * *
  #   - cron:  '0 12 * * 0'

jobs:
  report_status:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: âš¡ï¸ Invoke Status Report Lambda Function
        id: lambdaInvocation
        uses: gagoar/invoke-aws-lambda@master
        with:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          FunctionName: ${{ github.event.repository.name }}-prod-reportStatus

      - name: âœï¸ Store response payload to file
        if: always()
        run: echo '${{ fromJSON(steps.lambdaInvocation.outputs.response).Payload }}' > status-report.json

      - name: ðŸ—ƒï¸ Format report
        if: always()
        run: |
          cat > report.md
          echo '## Crawler Status Report' >> report.md
          echo '```json' >> report.md
          echo '${{ fromJSON(steps.lambdaInvocation.outputs.response).Payload }}' >> report.md
          echo '```' >> report.md   

      - name: â¬†ï¸ Upload report artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: report-markdown
          path: report.md 

      - name: ðŸ’« Job Summary Output
        if: always()
        # echo '${{ fromJSON(steps.lambdaInvocation.outputs.response).Payload }}' >> $GITHUB_STEP_SUMMARY
        # echo '```' >> $GITHUB_STEP_SUMMARY
        # echo "$(cat status-report.json )" >> $GITHUB_STEP_SUMMARY
        # echo "$(jq <<< status-report.json )" >> $GITHUB_STEP_SUMMARY
        run: | 
          echo '## Crawler Status Report' >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$( cat status-report.json | jq . | jq ."body")" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
         

      