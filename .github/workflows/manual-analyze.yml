name: üëÄ Analyze Custom Repo

on:
  workflow_dispatch:
    inputs:
      repo_user:
        type: string
        description: <github_username>
        required: true
      repo_name:
        type: string
        description: <github_repository>
        required: true

jobs:
  fetch_repo_url:
    name: "üöß Validate Action Inputs"
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      repoUrl: ${{ steps.repoUrlOutput.outputs.repoUrl }}

    steps:
      - name: "üöß Test [repo_user] input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: user-regex-check
        with:
          text: ${{ github.event.inputs.repo_user }}
          regex: '[\w,\-]'

      - name: "üö´ Deny invalid snippet [repo_name] input"
        if: ${{ steps.user-regex-check.outputs.match == '' }}
        run: |
          echo "Invalid user folder path"
          exit 1
          
      - name: "üöß Test [repo_name] input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: name-regex-check
        with:
          text: ${{ github.event.inputs.repo_name }}
          regex: '[\w,\-,\_]'

      - name: "üö´ Deny invalid snippet [repo_name] input"
        if: ${{ steps.name-regex-check.outputs.match == '' }}
        run: |
          echo "Invalid repo name folder path"
          exit 1
          
      - name: ‚úÇÔ∏è Extract repository URL from previous step
        # run: echo ::set-output name=repoUrl::$(cat invocation-response.json | jq . | jq .body.repoUrl | tr -d '"' 2>&1)
        run: echo ::set-output name=repoUrl::"${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}"
        id: repoUrlOutput
  
  security_scan:
    needs: [fetch_repo_url]
    name: "üõ°Ô∏è Security Scan"
    runs-on: ubuntu-latest
    if: ${{ needs.fetch_repo_url.outputs.repoUrl }} && github.ref == 'refs/heads/main'
    env:
      REPO_URL: ${{ needs.fetch_repo_url.outputs.repoUrl }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout external repository
        if: ${{ env.REPO_URL }}
        id: checkout-external-repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.REPO_URL }}
      
      - name: ‚úèÔ∏è Initialize analysis report
        run: |
          mkdir security
          cd security
          mkdir codeql
          mkdir SCAN
          cd ..
      
      - name: üõ†Ô∏è Initialize CodeQL
        if: steps.checkout-external-repo.outcome == 'success' && steps.checkout-external-repo.conclusion == 'success'
        uses: github/codeql-action/init@v2
        with:
          debug: true
      
      - name: üèóÔ∏è Autobuild Repo Code
        if: steps.checkout-external-repo.outcome == 'success' && steps.checkout-external-repo.conclusion == 'success'
        uses: github/codeql-action/autobuild@v2

      - name: ‚úÖ Perform CodeQL Analysis
        if: always() && steps.checkout-external-repo.outcome == 'success' && steps.checkout-external-repo.conclusion == 'success'
        id: codeql-analysis
        uses: github/codeql-action/analyze@v2
        with:
          upload: "false"
          add-snippets: "true"
          output: "../results"

      - name: üìÅ Move CodeQL results into output folder
        if: always() && steps.codeql-analysis.outcome == 'success' && steps.codeql-analysis.conclusion == 'success'
        run: cp -a ../results/. ./security/codeql
        
      # Alternate code scan
      # https://github.com/marketplace/actions/security-and-licence-scan
      # NOTES:
      #   - This action needs to be provided with a link to the target repository
      #   - When WORKSPACE is set, it can auto-build the source code
      #   - When WORKSPACE is set, it can auto-detect the languages as well
      #   - It will scan the dependencies and code from there

      - name: ‚úÖ Perform SCAN Analysis
        if: always() && steps.checkout-external-repo.outcome == 'success' && steps.checkout-external-repo.conclusion == 'success'
        id: scan-analysis
        uses: ShiftLeftSecurity/scan-action@master
        # with:
        #   src: ${{ env.REPO_URL }} NOT WORKING
        env:
          WORKSPACE: https://github.com/${{ env.REPO_URL }}
          SCAN_AUTO_BUILD: true
          
      - name: üìÅ Move SCAN results into output folder
        if: always() && steps.scan-analysis.outcome == 'success' && steps.scan-analysis.conclusion == 'success'
        run: cp -a ./reports/. ./security/SCAN

      - name: ‚¨ÜÔ∏è Upload security scan results
        if: always() && (steps.scan-analysis.outcome == 'success' || steps.codeql-analysis.conclusion == 'success')
        uses: actions/upload-artifact@v3
        with:
          name: security
          path: security
  
  # Preform typo scan
  # https://github.com/crate-ci/typos
  # https://crates.io/crates/typos-cli
  typo_scan:
    needs: [fetch_repo_url]
    name: "üö´ Typo Scan"
    runs-on: ubuntu-latest
    if: ${{ needs.fetch_repo_url.outputs.repoUrl }} && github.ref == 'refs/heads/main'
    env:
      REPO_URL: ${{ needs.fetch_repo_url.outputs.repoUrl }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout external repository
        if: ${{ env.REPO_URL }}
        id: checkout-external-repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.REPO_URL }}
      
      - name: ‚úèÔ∏è Initialize analysis report
        run: |
          mkdir typos
          cd typos
          touch typos.txt
          touch README.md
          cd ..
      
      - name:  üõ†Ô∏è Configure rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: üõ†Ô∏è Configure rust cargo (package manager)
        if: always()
        uses: actions-rs/cargo@v1
    
      - name: üì¶ Install spell-checker dependency
        run: cargo install typos-cli
        
      - name: üõ†Ô∏è Create spell checker config file
        run: |
          touch _typos.toml
          echo "[files]" >> _typos.toml
          echo "extend-exclude = ['typos/**', 'public/**']" >> _typos.toml

      - name: üö´ Preform typo scan
        id: typo-scan
        run: |
          echo '## Detected Typos' >> typos/typos.txt
          ${{ github.workspace }}/../../../.cargo/bin/typos >> typos/typos.txt || true
          echo '## Detected Typos Diff' >> typos/README.md
          echo '```diff' >> typos/README.md
          ${{ github.workspace }}/../../../.cargo/bin/typos --diff >> typos/README.md || true
          
      - name: ‚¨ÜÔ∏è Upload typo scan results
        uses: actions/upload-artifact@v3
        with:
          name: typos
          path: typos

  finalize_report:
    needs: [fetch_repo_url, security_scan, typo_scan]
    name: "üìù Finalize Report"
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    env:
      REPO_URL: ${{ needs.fetch_repo_url.outputs.repoUrl }}
    
    steps:
      - name: ‚úèÔ∏è Create analysis report files
        if: always()
        run: |
          mkdir output
          cd output
          touch README.md
          echo "# üß™ Repository Analysis Report" >> README.md
          echo "" >> README.md
          echo "## üè∑Ô∏è Metadata" >> README.md
          echo "" >> README.md
          echo "Repository:" >> README.md
          echo '[${{ env.REPO_URL }}](https://github.com/${{ env.REPO_URL }})' >> README.md
          echo "" >> README.md
          echo "Analysis Date:" >> README.md
          date >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "## [üõ°Ô∏è Security Scan](./security)" >> README.md
          echo "" >> README.md
          echo "" >> README.md
          echo "## [üö´ Typo Scan](./typos)" >> README.md
          echo "" >> README.md
          echo "" >> README.md
          cd ..

      - name: ‚¨áÔ∏è Download security scan results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: security
          path: security
          
      - name: ‚¨áÔ∏è Download typo scan results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: typos
          path: typos

      - name: üöö Move scan results into output folder
        if: always()
        run: |
          cd output
          mkdir security
          mkdir typos
          cd ..
          [ -d "./security" ] && cp -a ./security/. output/security || true
          [ -d "./typos" ] && cp -a ./typos/. output/typos || true
      
      - name: üìù Add job summary output
        run: |
          echo "# üß™ Repository Analyzed" >> README.md
          echo "" >> README.md
          echo "## üè∑Ô∏è Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> README.md
          echo "Repository:" >> $GITHUB_STEP_SUMMARY
          echo '[${{ env.REPO_URL }}](https://github.com/${{ env.REPO_URL }})' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Analysis Date:" >> README.md
          echo "" >> $GITHUB_STEP_SUMMARY
          date >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
      - name: üöö Push report to store repository
        if: always() && ${{ needs.security_scan.result == 'success' || needs.typo_scan.result == 'success' }}
        uses: cpina/github-action-push-to-another-repository@main
        env:
          # SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          API_TOKEN_GITHUB: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          source-directory: output
          destination-github-username: spencerlepine
          destination-repository-name: ${{ secrets.CONTRIBUTION_STORE_REPO }}
          target-directory: ${{ env.REPO_URL }}
          user-email: spencerlepine26@gmail.com
          target-branch: main

  email_notification:
    needs: [fetch_repo_url, security_scan, typo_scan, finalize_report]
    name: "üîî Send Email Notification"
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    env:
      REPO_URL: ${{ needs.fetch_repo_url.outputs.repoUrl }}
      
    steps:
      - name: üîä Send conditional failure mail
        if: ${{ needs.security_scan.result == 'failure' && needs.typo_scan.result == 'failure' }}
        uses: dawidd6/action-send-mail@v3.7.0
        with:
          # mail server settings
          server_address: smtp.gmail.com
          server_port: 465
          # user credentials
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          # email subject
          subject: ‚ùå (FAILURE) Analysis workflow - (${{ env.REPO_URL }})
          # email body as text
          body: |
            Repo Analysis failed for https://github.com/${{ env.REPO_URL }}
            
            View the workflow run here: https://github.com/spencerlepine/open-source-crawler/actions/runs/${{ github.run_id }}
          # comma-separated string, send email to
          to: spencerlepine26@gmail.com
          # from email name
          from: SpencerBot

      - name: üîä Send conditional success mail
        if: ${{ needs.security_scan.result == 'success' || needs.typo_scan.result == 'success' }}
        uses: dawidd6/action-send-mail@v3.7.0
        with:
          # mail server settings
          server_address: smtp.gmail.com
          server_port: 465
          # user credentials
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          # email subject
          subject: üéâ (NEW) Repository Analysis Success - (${{ env.REPO_URL }})
          # email body as text
          body: |
            Repo Analysis succeeded for https://github.com/${{ env.REPO_URL }}
            
            View the report here: https://github.com/spencerlepine/${{ secrets.CONTRIBUTION_STORE_REPO }}/tree/main/${{ env.REPO_URL }}

            View the workflow run here: https://github.com/spencerlepine/open-source-crawler/actions/runs/${{ github.run_id }}
          # comma-separated string, send email to
          to: spencerlepine26@gmail.com
          # from email name
          from: SpencerBot